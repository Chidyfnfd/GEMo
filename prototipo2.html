<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMo - Gestor Emocional</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- React, ReactDOM, and Babel for JSX in browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom style for the range slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- La aplicación React se montará aquí -->
    </div>

    <script type="text/babel">
        // --- Constantes de la Aplicación ---
        const APP_PREFIX = 'gemo_';
        const STORAGE_KEYS = {
          IS_LOGGED_IN: `${APP_PREFIX}isLoggedIn`,
          ENTRIES: `${APP_PREFIX}entries`,
          EMOTIONS_LIST: `${APP_PREFIX}emotionsList`,
          HABITS_LIST: `${APP_PREFIX}habitsList`
        };

        const DEFAULT_EMOTIONS = ["Estrés", "Ansiedad", "Frustración", "Calma", "Alegría"];
        const DEFAULT_HABITS = ["Ejercicio", "Trabajo", "Descanso", "Socializar", "Meditar"];

        // --- Funciones de Ayuda ---

        /**
         * Obtiene la fecha actual en formato ISO (YYYY-MM-DD)
         * @returns {string} - La fecha en formato ISO
         */
        const getISODate = (date = new Date()) => {
          return date.toISOString().split('T')[0];
        };

        /**
         * Hook personalizado para gestionar el estado en localStorage
         */
        function useStickyState(defaultValue, key) {
          const [value, setValue] = React.useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            try {
              return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            } catch (e) {
              console.error("Error al parsear localStorage", e);
              return defaultValue;
            }
          });

          React.useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);

          return [value, setValue];
        }

        // --- Componentes de la Interfaz ---

        /**
         * 0. Pantalla de Autenticación (Módulo 0)
         * Muestra la bienvenida y los botones de login/registro simulados.
         */
        function AuthScreen({ onLogin }) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-cyan-50 p-4">
              <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg text-center">
                <h1 className="text-4xl font-bold text-cyan-800 mb-4">
                  Bienvenido a GEMo
                </h1>
                <p className="text-gray-600 mb-8">
                  Tu Gestor Emocional personal. Registra tus emociones y encuentra patrones.
                </p>
                <div className="space-y-4">
                  <button
                    onClick={onLogin}
                    className="w-full bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition duration-300"
                  >
                    Iniciar Sesión
                  </button>
                  <button
                    onClick={onLogin}
                    className="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition duration-300"
                  >
                    Registrarse (Simulado)
                  </button>
                </div>
                {/* Mensaje de RNF3 eliminado según solicitud */}
              </div>
            </div>
          );
        }

        /**
         * Cabecera de la aplicación principal
         * Muestra la navegación y el botón de cerrar sesión.
         */
        function Header({ currentView, setView, onLogout }) {
          const navButtonClasses = (viewName) =>
            `py-2 px-4 rounded-lg font-medium transition-colors ${
              currentView === viewName
                ? 'bg-cyan-600 text-white'
                : 'text-gray-600 hover:bg-cyan-100'
            }`;

          return (
            <header className="bg-white shadow-sm p-4 sticky top-0 z-10">
              <div className="container mx-auto flex justify-between items-center">
                <h1 className="text-2xl font-bold text-cyan-800">GEMo</h1>
                <nav className="flex items-center space-x-2">
                  <button
                    onClick={() => setView('register')}
                    className={navButtonClasses('register')}
                  >
                    Registro
                  </button>
                  <button
                    onClick={() => setView('reports')}
                    className={navButtonClasses('reports')}
                  >
                    Reportes
                  </button>
                  <button
                    onClick={onLogout}
                    className="ml-4 text-sm text-gray-500 hover:text-red-600"
                  >
                    Cerrar Sesión
                  </button>
                </nav>
              </div>
            </header>
          );
        }

        /**
         * 1. Formulario de Registro Rápido (RF1 / HU-1)
         * Con campos para añadir emociones y hábitos
         */
        function EntryForm({ addEntry, emotions, habits, onAddEmotion, onAddHabit }) {
          const [emotionLevel, setEmotionLevel] = React.useState(5);
          const [emotionName, setEmotionName] = React.useState(emotions[0]);
          const [habit, setHabit] = React.useState(habits[0]);
          const [showSuccess, setShowSuccess] = React.useState(false);
          const [newEmotion, setNewEmotion] = React.useState("");
          const [newHabit, setNewHabit] = React.useState("");
          
          // Sincronizar estado si la lista de emociones cambia (ej. al añadir una nueva)
          React.useEffect(() => {
            if (!emotions.includes(emotionName)) {
              setEmotionName(emotions[0] || "");
            }
          }, [emotions, emotionName]);

          React.useEffect(() => {
            if (!habits.includes(habit)) {
              setHabit(habits[0] || "");
            }
          }, [habits, habit]);


          const handleSubmit = (e) => {
            e.preventDefault();
            
            if (!emotionName || !habit) {
              // Reemplazar alert() con UI Box si fuera posible. Usaremos console.log por ahora.
              console.error("Por favor, selecciona una emoción y un hábito.");
              return;
            }

            const newEntry = {
              date: getISODate(),
              emotionLevel: parseInt(emotionLevel, 10),
              emotionName,
              habit,
              timestamp: Date.now()
            };
            
            addEntry(newEntry);

            // Resetear formulario y mostrar feedback
            setEmotionLevel(5);
            setEmotionName(emotions[0]);
            setHabit(habits[0]);
            setShowSuccess(true);
            
            setTimeout(() => {
              setShowSuccess(false);
            }, 2000); // Mensaje de éxito rápido
          };

          const getSliderColor = () => {
            if (emotionLevel <= 4) return '#22c55e'; // green-500
            if (emotionLevel <= 7) return '#eab308'; // yellow-500
            return '#ef4444'; // red-500
          };

          const handleAddNewEmotion = () => {
            if (newEmotion.trim()) {
              onAddEmotion(newEmotion.trim());
              setNewEmotion(""); // Clear input
            }
          };

          const handleAddNewHabit = () => {
            if (newHabit.trim()) {
              onAddHabit(newHabit.trim());
              setNewHabit(""); // Clear input
            }
          };


          return (
            <div className="w-full max-w-lg mx-auto p-6">
              {showSuccess && (
                <div className="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-6" role="alert">
                  <p className="font-bold">¡Guardado!</p>
                  <p>Tu registro emocional ha sido guardado.</p>
                </div>
              )}

              <form onSubmit={handleSubmit} className="bg-white p-8 rounded-2xl shadow-lg space-y-6">
                <h2 className="text-2xl font-semibold text-gray-800 text-center">¿Cómo te sientes ahora?</h2>
                
                {/* Nivel de Emoción (Slider) */}
                <div>
                  <label htmlFor="emotionLevel" className="block text-sm font-medium text-gray-700 mb-2">
                    Nivel de Emoción: <span className="font-bold text-xl text-cyan-700">{emotionLevel}</span>
                  </label>
                  <input
                    type="range"
                    id="emotionLevel"
                    min="1"
                    max="10"
                    value={emotionLevel}
                    onChange={(e) => setEmotionLevel(e.target.value)}
                    className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg"
                    style={{ 
                      // Estilo para simular el progreso
                      background: `linear-gradient(to right, ${getSliderColor()} 0%, ${getSliderColor()} ${emotionLevel * 10}%, #e5e7eb ${emotionLevel * 10}%, #e5e7eb 100%)`
                    }}
                  />
                </div>

                {/* Nombre de Emoción (Botones) */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Emoción Principal
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {emotions.map((emotion) => (
                      <button
                        key={emotion}
                        type="button"
                        onClick={() => setEmotionName(emotion)}
                        className={`py-2 px-4 rounded-full text-sm font-medium transition-all ${
                          emotionName === emotion
                            ? 'bg-cyan-600 text-white ring-2 ring-cyan-300'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        {emotion}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Add Emotion */}
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={newEmotion}
                    onChange={(e) => setNewEmotion(e.target.value)}
                    placeholder="Nueva emoción"
                    className="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-cyan-500 focus:border-cyan-500"
                  />
                  <button
                    type="button"
                    onClick={handleAddNewEmotion}
                    className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 text-sm"
                  >
                    + Añadir
                  </button>
                </div>

                {/* Hábito/Actividad (Botones) */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Actividad Reciente
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {habits.map((h) => (
                      <button
                        key={h}
                        type="button"
                        onClick={() => setHabit(h)}
                        className={`py-2 px-4 rounded-full text-sm font-medium transition-all ${
                          habit === h
                            ? 'bg-cyan-600 text-white ring-2 ring-cyan-300'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        {h}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Add Habit */}
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={newHabit}
                    onChange={(e) => setNewHabit(e.target.value)}
                    placeholder="Nuevo hábito"
                    className="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-cyan-500 focus:border-cyan-500"
                  />
                  <button
                    type="button"
                    onClick={handleAddNewHabit}
                    className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 text-sm"
                  >
                    + Añadir
                  </button>
                </div>
                
                {/* Botón de Guardar */}
                <button
                  type="submit"
                  className="w-full bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition duration-300"
                >
                  Guardar Registro
                </button>
              </form>
            </div>
          );
        }

        /**
         * 2. Gráfico de Reporte (SVG Simple) (RF2)
         * Muestra la tendencia de los últimos 7 registros.
         */
        function ReportChart({ data }) {
          if (!data || data.length === 0) return null;

          const width = 300;
          const height = 100;
          const padding = 20;
          
          const points = data.map((entry, index) => {
            // Asegurar que haya al menos 2 puntos para dibujar una línea
            const x = (data.length > 1) 
              ? padding + (index / (data.length - 1)) * (width - 2 * padding)
              : width / 2; // Centrar si solo hay un punto
            const y = (height - padding) - ((entry.emotionLevel - 1) / 9) * (height - 2 * padding);
            return { x, y, level: entry.emotionLevel };
          });

          const pathD = "M" + points.map(p => `${p.x},${p.y}`).join(" L ");

          return (
            <div className="w-full p-4 bg-gray-50 rounded-lg overflow-x-auto">
              <svg viewBox={`0 0 ${width} ${height}`} className="w-full min-w-[300px]" preserveAspectRatio="xMidYMid meet">
                {/* Eje Y (Niveles) */}
                <text x="5" y={padding + 5} fontSize="8" fill="gray">10</text>
                <text x="5" y={height / 2} fontSize="8" fill="gray">5</text>
                <text x="5" y={height - padding + 5} fontSize="8" fill="gray">1</text>
                <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#e0e0e0" strokeDasharray="2" />
                
                {/* Gráfica de Línea (Solo si hay más de 1 punto) */}
                {points.length > 1 && (
                  <path d={pathD} fill="none" stroke="#0891b2" strokeWidth="2" />
                )}
                
                {/* Puntos en la gráfica */}
                {points.map((p, i) => (
                  <circle
                    key={i}
                    cx={p.x}
                    cy={p.y}
                    r="3"
                    fill={p.level > 7 ? "#ef4444" : (p.level > 4 ? "#eab308" : "#22c55e")}
                  >
                    <title>Nivel: {p.level}</title>
                  </circle>
                ))}
              </svg>
              {data.length > 1 && (
                <div className="flex justify-between text-xs text-gray-500 mt-1 px-4">
                  <span>Registro 1</span>
                  <span>Registro {data.length}</span>
                </div>
              )}
            </div>
          );
        }

        /**
         * 2. Análisis de Patrones (RF2 / HU-2)
         */
        function ReportAnalysis({ peakEntry }) {
          return (
            <div className="mt-6">
              <h3 className="text-xl font-semibold text-gray-800 mb-2">Análisis de Patrones</h3>
              {peakEntry ? (
                <div className="bg-red-100 border border-red-200 text-red-800 p-4 rounded-lg">
                  <p>
                    <span className="font-bold">Pico detectado:</span> Se registró un nivel de 
                    <strong className="mx-1">{peakEntry.emotionName}</strong> de 
                    <strong className="mx-1">{peakEntry.emotionLevel}</strong> el día 
                    <strong className="ml-1">{peakEntry.date}</strong>.
                  </p>
                </div>
              ) : (
                <p className="text-gray-600">No se detectaron picos de estrés o ansiedad (mayores a 7) en los últimos 7 registros.</p>
              )}
            </div>
          );
        }

        /**
         * 3. Recomendaciones (RF3 / HU-3)
         */
        function Recommendations({ show }) {
          if (!show) {
            return (
              <div className="mt-6 text-gray-600">
                <p>Tu nivel promedio de estrés/ansiedad está estable. ¡Sigue así!</p>
              </div>
            );
          }

          return (
            <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <h3 className="text-xl font-semibold text-blue-800 mb-2">Sugerencias y Apoyo</h3>
              <p className="text-blue-700 mb-4">
                Hemos notado un patrón de estrés o ansiedad elevado. Considera tomarte un momento para ti.
              </p>
              
              {/* Sugerencia de Autocuidado */}
              <div className="mb-4">
                <h4 className="font-semibold">Sugerencia de Autocuidado:</h4>
                <p className="text-gray-700">Tómate 10 minutos para una respiración profunda hoy. Cierra los ojos y enfócate solo en tu respiración.</p>
              </div>
              
              {/* Recurso de Apoyo */}
              <div>
                <h4 className="font-semibold">Recurso de Apoyo:</h4>
                <a
                  href="https://www.who.int/es/campaigns/connecting-the-world-to-combat-coronavirus/healthyathome/mental-health"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-block bg-blue-600 text-white font-medium py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Buscar Apoyo Profesional (Ejemplo)
                </a>
              </div>
            </div>
          );
        }

        /**
         * Historial de Registros
         * Muestra una lista de todas las entradas.
         */
        function EntryHistoryList({ entries }) {
          // Ordena las entradas de más reciente a más antigua
          const sortedEntries = React.useMemo(() => 
            [...entries].sort((a, b) => b.timestamp - a.timestamp), 
            [entries]
          );

          if (sortedEntries.length === 0) {
            return (
              <div className="text-center text-gray-500 py-4">
                Aún no tienes registros guardados.
              </div>
            );
          }

          // Función para formatear el timestamp a una fecha y hora legibles
          const formatTimestamp = (timestamp) => {
            return new Date(timestamp).toLocaleString('es-ES', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          };

          return (
            <div className="mt-8">
              <h3 className="text-2xl font-semibold text-gray-800 mb-4">Historial Completo</h3>
              <div className="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                <ul className="divide-y divide-gray-200">
                  {sortedEntries.map((entry) => (
                    <li key={entry.timestamp} className="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                      <div className="flex-1">
                        <p className="text-base font-semibold text-gray-900">{entry.emotionName}</p>
                        <p className="text-sm text-gray-500">{formatTimestamp(entry.timestamp)}</p>
                      </div>
                      <div className="ml-4">
                        <span className={`text-xl font-bold px-3 py-1 rounded-full ${
                          entry.emotionLevel > 7 ? 'text-red-800 bg-red-100' :
                          entry.emotionLevel > 4 ? 'text-yellow-800 bg-yellow-100' :
                          'text-green-800 bg-green-100'
                        }`}>
                          {entry.emotionLevel}
                        </span>
                      </div>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          );
        }


        /**
         * Panel de Reportes (Módulo 2 & 3)
         * Contiene el gráfico, análisis, recomendaciones e historial.
         */
        function ReportDashboard({ entries }) {

          // Usamos useMemo para evitar recalcular en cada render
          const analysis = React.useMemo(() => {
            // La precondición (RNF2) ahora solo aplica al análisis de patrones
            if (entries.length < 7) return null;

            const last7Entries = entries.slice(-7);
            
            const stressAnxietyEntries = last7Entries.filter(
              (e) => (e.emotionName === "Estrés" || e.emotionName === "Ansiedad")
            );

            // RF2: Análisis de Patrones (Pico)
            const peakEntry = stressAnxietyEntries
              .filter(e => e.emotionLevel > 7)
              .sort((a, b) => b.emotionLevel - a.emotionLevel)[0] || null;

            // RF3: Lógica de Recomendación (Promedio)
            let avgStressAnxiety = 0;
            if (stressAnxietyEntries.length > 0) {
              const sum = stressAnxietyEntries.reduce((acc, e) => acc + e.emotionLevel, 0);
              avgStressAnxiety = sum / stressAnxietyEntries.length;
            }
            
            const showRecommendations = avgStressAnxiety > 7;

            return { last7Entries, peakEntry, showRecommendations };
          }, [entries]);

          return (
            <div className="w-full max-w-3xl mx-auto p-6 space-y-8">
              
              {/* --- Sección de Análisis (Condicional) --- */}
              {analysis ? (
                // Si hay 7 o más entradas, muestra el análisis
                <div className="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                  <h2 className="text-3xl font-bold text-gray-800 mb-6">Tu Reporte Semanal</h2>
                  
                  {/* Módulo 2: Gráfica de Línea */}
                  <h3 className="text-xl font-semibold text-gray-800 mb-2">Tendencia (Últimos 7 Registros)</h3>
                  <ReportChart data={analysis.last7Entries} />
                  
                  {/* Módulo 2: Análisis de Patrones */}
                  <ReportAnalysis peakEntry={analysis.peakEntry} />
                  
                  {/* Módulo 3: Recomendaciones */}
                  <Recommendations show={analysis.showRecommendations} />
                </div>
              ) : (
                // Si hay entre 1 y 6 entradas, muestra el aviso
                entries.length > 0 && (
                  <div className="w-full text-center">
                    <div className="bg-white p-8 rounded-2xl shadow-lg inline-block">
                      <h2 className="text-2xl font-semibold text-gray-800 mb-4">Reportes Aún No Disponibles</h2>
                      <p className="text-gray-600">
                        Necesitas al menos <span className="font-bold">7 registros</span> para generar tu primer reporte de patrones.
                      </p>
                      <p className="text-gray-600 mt-2">
                        ¡Sigue registrando! Te faltan <span className="font-bold">{7 - entries.length}</span> registros.
                      </p>
                    </div>
                  </div>
                )
              )}

              {/* --- Sección de Historial (Siempre se muestra) --- */}
              <div className="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <EntryHistoryList entries={entries} />
              </div>

            </div>
          );
        }


        /**
         * Componente Principal de la Aplicación
         */
        function App() {
          // RNF1: Estado de autenticación simulado
          const [isLoggedIn, setIsLoggedIn] = useStickyState(
            false,
            STORAGE_KEYS.IS_LOGGED_IN
          );
          
          // RNF3: Almacenamiento local de registros
          const [entries, setEntries] = useStickyState(
            [],
            STORAGE_KEYS.ENTRIES
          );
          
          // Estado para listas personalizables
          const [emotionsList, setEmotionsList] = useStickyState(
            DEFAULT_EMOTIONS,
            STORAGE_KEYS.EMOTIONS_LIST
          );
          const [habitsList, setHabitsList] = useStickyState(
            DEFAULT_HABITS,
            STORAGE_KEYS.HABITS_LIST
          );

          // Estado para la navegación interna
          const [currentView, setCurrentView] = React.useState('register'); // 'register' o 'reports'

          // --- Manejadores de Estado ---

          const handleLogin = () => {
            setIsLoggedIn(true);
          };

          const handleLogout = () => {
            setIsLoggedIn(false);
          };

          const addEntry = (newEntry) => {
            setEntries(prevEntries => [...prevEntries, newEntry]);
          };

          // Funciones para añadir elementos a las listas
          const addCustomEmotion = (emotion) => {
            if (emotion && !emotionsList.includes(emotion)) {
              setEmotionsList([...emotionsList, emotion]);
            }
          };

          const addCustomHabit = (habit) => {
            if (habit && !habitsList.includes(habit)) {
              setHabitsList([...habitsList, habit]);
            }
          };

          // Renderizado condicional basado en la autenticación
          if (!isLoggedIn) {
            return <AuthScreen onLogin={handleLogin} />;
          }

          // Interfaz Principal (Autenticada)
          return (
            <div className="min-h-screen bg-cyan-50">
              <Header
                currentView={currentView}
                setView={setCurrentView}
                onLogout={handleLogout}
              />
              
              <main className="py-6">
                {currentView === 'register' && (
                  <EntryForm 
                    addEntry={addEntry} 
                    emotions={emotionsList}
                    habits={habitsList}
                    onAddEmotion={addCustomEmotion}
                    onAddHabit={addCustomHabit}
                  />
                )}
                
                {currentView === 'reports' && (
                  <ReportDashboard entries={entries} />
                )}
              </main>
            </div>
          );
        }

        // Montar la aplicación
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>